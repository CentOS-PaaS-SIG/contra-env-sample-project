def libraries = ['contra-lib': ['master', 'https://github.com/openshift/contra-lib.git']]

libraries.each { name, repo ->
    library identifier: "${name}@${repo[0]}",
            retriever: modernSCM([$class: 'GitSCMSource',
                                  remote: repo[1]])

}

containers = [
        'rpmbuild':
        [
                tag: env.RPMBUILD_TAG
        ],
        'cloud-image-compose':
        [
                tag: env.CLOUD_IMAGE_COMPOSE_TAG
        ],
        'singlehost-test':
        [
                tag: env.SINGLEHOST_TEST_TAG
        ]
]
podName = "contra-sample-pipeline-${UUID.randomUUID().toString()}"
env.DOCKER_REPO_URL = env.DOCKER_REPO_URL ?: '172.30.1.1:5000'
env.OPENSHIFT_NAMESPACE = env.OPENSHIFT_NAMESPACE ?: 'contra-sample-project'
prMessage = prMessage(env.CI_MESSAGE)

msgHeader = fedMsgHeader(repo: prMessage['repo'], namespace: 'contra-env-sample', username: prMessage['username'])
msgComplete = fedMsgComplete(header: msgHeader)
msgError = fedMsgError(header: msgHeader)

deployOpenShiftTemplate(podName: podName, containersWithProps: containers, docker_repo_url: DOCKER_REPO_URL,
                        openshift_namespace: OPENSHIFT_NAMESPACE) {

    ciPipeline(package_name: prMessage['repo'], buildPrefix: 'contra-env-sample', sendMetrics: false,
               completeMsg: msgComplete, errorMsg: msgError) {

        stage('rpm-build') {
            rpmBuildPR(repo: prMessage['repo'], id: prMessage['id'], uid: prMessage['uid'])
        }

        stage('repo-query') {
            repoQuery(repo: prMessage['repo'])
        }

        stage('image-compose') {
            imageCompose(package: prMessage['repo'], branch: prMessage['branch'], release: prMessage['release'])
        }

        stage('package-tests') {
            packageTests(package: prMessage['repo'], branch: prMessage['branch'])
        }

    }
}
